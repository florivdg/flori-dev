---
title: 'Broadcasting my default Browser with Server-sent Events'
pubDate: 2023-07-05
description: 'My Uses page updates in real-time which default browser I am using right now. Whether Iâ€™m feeling a fiery passion for Firefox or a magnetic attraction to Safari, it will always reveal which browser has stolen my heart (for now). So sit back, let it refresh, and witness the drama unfold. Why? Because the world deserves to know!'
tags: ['sse', 'browser', 'deno deploy', 'kv', 'swift']
---

My [Uses page](/uses) updates in real-time which default browser I am using right now.

Whether I'm feeling a fiery passion for Firefox or a magnetic attraction to Safari, it will always reveal which browser has stolen my heart (for now). So sit back, let it refresh, and witness the drama unfold. It's like The Bachelor, but for browsers.

Why? Because the world deserves to know!

## The macOS part

I wrote a tiny Swift command line app that runs as a LaunchAgent in the background and broadcasts my default browser to a [Deno Deploy](https://deno.com/deploy) backend running on the edge, distributed across various data centers [around the world](https://deno.com/deploy/docs/regions).

```swift
// Get the URL of the current default browser
let workspace = NSWorkspace.shared
let newURL = workspace.urlForApplication(toOpen: webURL)

// If the URL has changed, create a dictionary with the new default browser data
let bundle = Bundle(url: newURL!)
let browserIdentifier = bundle?.bundleIdentifier ?? "unknown"
let defaultBrowserData = [
    "browser": browserIdentifier
]
```

The shared NSWorkspace singleton is used to get the local file system URL of the current default browser. If the URL has changed, a dictionary is created with the new default browser bundle identifier (eg. `com.apple.Safari` for Apple's Safari browser).

## The Deno KV part

The Swift app sends a POST request to a Deno Deploy backend. The backend is not only responsible for broadcasting the new default browser to all connected clients and to persist the current default browser in a [Deno KV](https://deno.com/kv) store (which is currently in Beta on Deno Deploy).

```typescript
/// Update the value in Deno.Kv
const db = await Deno.openKv()
await db.set(KV_KEY, value)
```

### What is Deno KV?

As the marketing copy says, Deno KV is a globally distributed, serverless key-value database for Deno applications, built on FoundationDB, that supports ACID transactions, provides zero-setup deployment with various consistency options, and enables seamless scaling from side projects to enterprise platforms.

So this is just right to store my current default browser and distribute it to all connected clients.

## The Server-sent Events part

First I started this project by using [WebSockets](https://developer.mozilla.org/en-US/docs/Web/API/WebSockets_API) to broadcast the new default browser to all connected clients. But I quickly realized that I don't need a full-duplex connection between the client and the server. I only need a one-way connection from the server to the client.

While working with the OpenAI API for a work project, I stumbled upon [Server-sent Events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events) which is a technology that allows a client to receive automatic, pushed updates from a server via HTTP connection.

```typescript
/// Create a event target that keeps the connection alive
const target = context.sendEvents({ keepAlive: true })

/// Subscribe to changes to the default browser
const unsubscribe = browser.subscribe((value) => {
  target.dispatchMessage(value)
})
```

Here I am running a Oak server on Deno Deploy. The `sendEvents` method returns a `Target` object that can be used to send events to the client. The `dispatchMessage` method sends that message to the client.

## The Edge part

As this backend application is running on Deno Deploy, it is distributed across various data centers around the world. So when I change my default browser on my machine, the new default browser is sent to the instance closest to me. This instance then stores the new bundle identifier in the Deno KV store. But the other world doesn't know about it yet.

Since there is now way of subscribing to changes in the Deno KV store, I need to make sure that all instances are aware of the new default browser. So I need to broadcast the new default browser to all other regions.

This is done by using the [`BroadcastChannel`](https://deno.com/deploy/docs/runtime-broadcast-channel) API.

> In Deno Deploy, the BroadcastChannel API provides a communication mechanism between the various instances; a simple message bus that connects the various Deploy instances world wide.

```typescript
/// Create a BroadcastChannel to communicate with other edge instances
const channel = new BroadcastChannel('earth')

/// Broadcast the change to all edge instances
channel.postMessage(value)
```

The other instances will then be notified of the new default browser and can inform their connected clients immediately. As you might have already noticed, time is crucial here.

```typescript
/// Handle messages from other edge instances
channel.onmessage = (event) => {
  /// Do not update the origin instance
  if (event.data === browser.value) return

  /* Update code here */
}
```

## The client part

On the client side a simple EventSource is used to listen for new default browser events. Since I am using Vue.js for rendering the browser component, I can make use of the `@vueuse/core` package to create a reactive EventSource.

```typescript
import { useEventSource } from '@vueuse/core'

const { status, data } = useEventSource(
  'https://van-der-hub.flori.dev/browser/live',
)
```

And that's it! Whenever I change my default browser, the world will know about it. And you can witness the drama unfold on my [Uses page](/uses).

## Source code

Swift app: [`main.swift`](https://github.com/florivdg/Default-Browser-Watcher/blob/main/Default%20Browser%20Watcher/main.swift)  
Deno Backend: [`browser.ts`](https://github.com/florivdg/van-der-hub/blob/main/browser.ts)  
Website: [`CurrentBrowser.vue`](https://github.com/florivdg/flori-dev/blob/main/src/components/CurrentBrowser.vue)
